/*
 *
 * Wijmo Library 1.4.1
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";var g="wijmo-wijcombobox-input",c="ui-state-hover",d="ui-state-active",b="ui-state-focus",f="ui-corner-left",e="ui-corner-right",h="<div class='wijmo-wijcombobox-trigger ui-state-default ui-corner-right'><span class='ui-icon ui-icon-triangle-1-s'></span></div>",i="<label class='wijmo-wijcombobox-label ui-widget-content'></label>";a.widget("wijmo.wijcombobox",{options:{data:null,labelText:null,minLength:4,delay:300,showingAnimation:null,hidingAnimation:null,showTrigger:true,triggerPosition:"right",dropdownHeight:300,dropdownWidth:"auto",selectOnItemFocus:false,autoFilter:true,autoComplete:true,highlightMatching:true,dropDownListPosition:{},columns:[],selectionMode:"single",multipleSelectionSeparator:",",forceSelectionText:false,select:null,isEditable:true,selectedIndex:-1,open:null,close:null,selectElementWidthFix:6,search:null,changed:null,listOptions:null},_create:function(){var a=this;a.selectedItem=null;a.selectedItems=[];a._createDOMElements();a._bindInputEvents();a._initDropDownList();a.repaint();a._checkSelectIndex()},_checkSelectIndex:function(){var c=this,b;b=c.options.selectedIndex;!c._usingRemoteData()&&(b>=0||a.isArray(b))&&c.search(null,"checkindex")},repaint:function(){var a=this;if(a.element.is(":visible")||a._select!==undefined&&a._input.is(":visible")){a._showTrigger();a.options.disabled&&a.disable();return true}return false},_bindInputEvents:function(){var c=this,e,f,g,d;e=c._input;f=c.options;e.bind("keydown.wijcombobox",function(b){if(f.disabled===true)return;g=b.keyCode;d=a.ui.keyCode;switch(g){case d.UP:c._move("previous",b);b.preventDefault();break;case d.DOWN:c._move("next",b);b.preventDefault();break;case d.ENTER:if(c.menu.active){b.preventDefault();c.menu.select(b)}break;case d.TAB:e.trigger("wijcomboblur");if(!c.menu.active||f.selectionMode==="multiple"&&d.TAB===g)return;c.menu.select(b);var h=e.val().length;c._selectText(h,h,e);break;case d.ESCAPE:c.close(b);break;case d.LEFT:case d.RIGHT:case d.SHIFT:case d.CONTROL:case d.HOME:case d.END:case d.DELETE:case d.PAGE_UP:case d.PAGE_DOWN:break;case 18:e.trigger("wijcomboblur");break;default:window.clearTimeout(c.searching);if(f.isEditable===false){if(c._cacheKey===undefined)c._cacheKey="";c._cacheKey+=String.fromCharCode(g)}c.searching=window.setTimeout(function(){var a;if(f.isEditable===false){a=c._cacheKey;c._cacheKey=undefined}else a=e.val();c.search(a,b)},f.delay)}}).bind("wijcomboblur.wijcombobox",function(a){window.clearTimeout(c.searching);c._addInputFocus(false,b);c.closing=window.setTimeout(function(){c.close(a,true)},150)}).bind("focus.wijcombobox",function(){c._addInputFocus(true,b)}).bind("blur.wijcombobox",function(){!c.menu.element.is(":visible")&&e.trigger("wijcomboblur");c._change()})},_addInputFocus:function(f,e){var c=this,d,b,a;d=c._input.parent();b=f?"addClass":"removeClass";a=c._triggerArrow;d[b](e);a!==undefined&&a[b](e)},_renderColumnsHeader:function(c){var b=a("<ul class='wijmo-wijcombobox-rowheader'></ul>");a.each(this.options.columns,function(e,c){var d=a("<li class='wijmo-wijcombobox-cell ui-widget-header'></li>");d.html(c.name);c.width!==undefined&&d.width(c.width);d.appendTo(b)});c.append(b)},_hasSameValueText:function(a,b){return a.label===b.label&&a.value===b.value},_initDropDownList:function(){var b=this,g,e,c,f,d;g=b.element[0].ownerDocument;e=a("<div class='wijmo-wijcombobox-list'></div>");c=b.options;if(c.columns.length>0){e.addClass("wijmo-wijcombobox-multicolumn");f=a("<div class='wijmo-wijsuperpanel-header ui-state-default'></div>");b._renderColumnsHeader(f);e.append(f)}d={keepHightlightOnMouseLeave:true,selectionMode:c.selectionMode,addHoverItemClass:c.columns.length===0,focus:function(e,d){var a=d;c.selectOnItemFocus&&b.menu.select(null,{notCloseAfterSelected:true});if(c.columns.length>0){a.element.prev().addClass("wijmo-wijcombobox-active-prev");a.element.find(".wijmo-wijcombobox-row>.wijmo-wijcombobox-cell").addClass("ui-state-hover")}},selected:function(i,f){window.clearTimeout(b.closing);var j=c.selectionMode,d,g,h,e;d=f.item;if(b._trigger("select",i,d))if(j==="single"){if(!b._usingRemoteData()){g=a.inArray(d,b.items);if(g!==c.selectedIndex){b._input.val(d.label);e=b.selectedItem;if(e!==null)e.selected=false;b.selectedItem=d;h=c.selectedIndex;c.selectedIndex=g;if(b._select!==undefined){b._select[0].selectedIndex=c.selectedIndex;b._select.trigger("change")}b._trigger("changed",null,{oldItem:e,selectedItem:b.selectedItem,newIndex:c.selectedIndex,oldIndex:h})}}else if(b.selectedItem===null||!b._hasSameValueText(d,b.selectedItem)){b._input.val(d.label);b.selectedItem=d;b._trigger("changed",null,{selectedItem:d})}}else if(!b._usingRemoteData()){b.selectedItems=f.selectedItems;b._selectedItemsToInputVal(b.selectedItems);b._trigger("changed",null,{selectedItem:d,selectedItems:b.selectedItems})}if((f.data===undefined||!f.data.notCloseAfterSelected)&&j==="single"){b.close(i);b._input.focus()}},blur:function(d,b){var a=b.element;if(c.columns.length>0){a.find(".wijmo-wijcombobox-row>.wijmo-wijcombobox-cell").removeClass("ui-state-hover");a.prev().removeClass("wijmo-wijcombobox-active-prev")}},itemRendering:function(g,f){var d=f,e;e="";if(d.isSeparator)e+=" wijmo-wijcombobox-separator";if(d.selected)e+=" wijmo-wijcombobox-selecteditem";e.length>0&&d.element.addClass(e);if(b._keypress&&c.isEditable&&c.columns.length===0&&c.highlightMatching&&a.trim(b._input.val()).length>0)d.text=d.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b._escapeRegex(b._input.val())+")(?![^<>]*>)(?![^&;]+;)","gi"),"<span class='ui-priority-primary'>$1</span>");else d.text=undefined},itemRendered:function(f,e){var b=e,c,d;if(b.cells===undefined)return;c=b.element;c.empty();d=a("<ul class='wijmo-wijcombobox-row'></ul>");a.each(b.cells,function(e,c){var b=a("<li class='wijmo-wijcombobox-cell ui-state-default'></li>");b.append(c);b.attr("title",c);d.append(b)});c.append(d)},superPanelOptions:{resized:function(){var d=b.menu,a=d.element;c.dropdownWidth=a.outerWidth();c.dropdownHeight=a.outerHeight();b._positionList();b.menu.refreshSuperPanel()}}};d=a.extend(true,d,c.listOptions);b.menu=e.appendTo("body",g).wijlist(d).zIndex(b._input.zIndex()+1).css({top:0,left:0}).hide().data("wijlist");b._menuUL=b.menu.ul},_selectedItemsToInputVal:function(e){var b="",c,d;c=this;d=c.options.multipleSelectionSeparator;c.selectedItems=e;a.each(e,function(c,a){b+=a.label+d});if(b.length>0)b=b.substr(0,b.lastIndexOf(d));c._input.val(b)},_createDOMElements:function(){var b=this,f,d,e;f=a("<div role='combobox' class='wijmo-wijcombobox ui-widget ui-helper-clearfix'><div class='wijmo-wijcombobox-wrapper ui-state-default ui-corner-all'></div></div>");d=b.element;b._comboElement=f;if(d[0].tagName.toLowerCase()==="select"){b._select=d;d.addClass("ui-widget");e=b._input=a("<input role='textbox' aria-autocomplete='list' aria-haspopup='true' />").insertAfter(d);b.options.data=b._convertSelectOptions()}else e=b._input=d;f.insertBefore(e);f.children(".wijmo-wijcombobox-wrapper").append(e);e.attr({autocomplete:"off",role:"textbox","aria-wijcombobox":"list","aria-haspopup":"true"}).addClass(g);b._oldWidth=d.css("width");b.options.isEditable===false&&e.attr("readonly","readonly");f.bind("mouseenter",function(){b._addInputFocus(true,c)}).bind("mouseleave",function(){b._addInputFocus(false,c)})},_convertSelectOptions:function(){var d=[],b,c;b=this;c=b._select.get(0).options;a.each(c,function(b,a){d.push({label:a.text,value:a.value})});b.options.selectedIndex=b._select[0].selectedIndex;return d},getComboElement:function(){return this._comboElement},_showTrigger:function(){var g=this,l,j,q,p,r,t=0,b,k,o,m,s,n;l=g.options;j=g._input;q=j.parent();p=g._comboElement;b=g._triggerArrow;k=g._label;if(g._select!==undefined){if(!a.browser.msie)t=g._select.width();else{r=g._select.clone();g._select.after(r);t=r.width();r.remove()}j.width(t+(l.data.length>20?l.selectElementWidthFix:0));g._select.hide()}j.css("margin-left","");j.css("margin-right","");p.width(q[0].offsetWidth);if(l.labelText!==null){k=g._label=a(i);q.append(k.html(l.labelText))}else if(k!==undefined){k.remove();g._label=undefined}if(l.showTrigger){j.removeClass("ui-corner-all");if(b===undefined){b=g._triggerArrow=a(h);p.append(b);b.bind("mouseover.triggerevent",g,function(d){if(l.disabled===true)return;var b=a(d.currentTarget);b.addClass(c)}).bind("mousedown.triggerevent",g,function(c){if(l.disabled===true)return;var b=a(c.currentTarget);b.addClass(d)}).bind("mouseup.triggerevent",g,function(c){var b=a(c.currentTarget);b.removeClass(d)}).bind("click.triggerevent",g,function(){if(l.disabled===true)return;g._triggerClick()})}if(l.triggerPosition==="right"){b.css({left:"",right:"0px"});b.removeClass(f);b.addClass(e)}else{b.css({right:"",left:"0px"});b.removeClass(e);b.addClass(f)}b.setOutHeight(p.innerHeight());o=b.find("span");o.css("margin-left",(b.innerWidth()-o[0].offsetWidth)/2);o.css("margin-top",(b.innerHeight()-o[0].offsetHeight)/2)}else{if(b!==undefined){b.unbind(".triggerevent");b.remove();g._triggerArrow=undefined}j.removeClass("ui-corner-left");j.removeClass("ui-corner-right");j.addClass("ui-corner-all")}m=s=n=0;if(k!==undefined)s+=k[0].offsetWidth;if(b!==undefined)n=b[0].offsetWidth;m=s+n;j.setOutWidth(q.innerWidth()-m);m=m===0?"":m;if(l.triggerPosition==="right"){j.css("margin-left","");j.css("margin-right",m);if(k!==undefined){k.css("left","");k.css("right",n)}}else{j.css("margin-right","");j.css("margin-left",m);if(k!==undefined){k.css("right","");k.css("left",n)}}},_triggerClick:function(c){var a=this,b="";window.clearTimeout(a.closing);if(a.menu.element.is(":visible"))a.close();else{if(a._usingRemoteData())b=a._input.val();a.search(b,c)}},destroy:function(){var b=this,c=b.element;b.options.isEditable===false&&c.removeAttr("readonly");if(b._select!==undefined){b._select.removeClass("ui-widget");b._select.show();b._input.remove()}else{c.css("width",b._oldWidth);c.removeClass(g);c.removeAttr("autocomplete").removeAttr("role").removeAttr("aria-wijcombobox").removeAttr("aria-haspopup");c.insertBefore(b._comboElement);c.css("padding","")}b._comboElement.remove();b.menu.destroy();b.menu.element.remove();a.Widget.prototype.destroy.call(b)},_setOption:function(e,d){var b=this,f,c;f=b._comboElement;c=b.element;a.Widget.prototype._setOption.apply(b,arguments);if(e==="disabled")if(d){f.addClass("wijmo-wijcombobox-disabled ui-state-disabled");c.attr("disabled","disabled");b.close()}else{f.removeClass("wijmo-wijcombobox-disabled ui-state-disabled");c.removeAttr("disabled")}else if(e==="isEditable")if(d)c.attr("readonly","readonly");else c.removeAttr("readonly");else if(e==="data"){b.selectedItem=null;b.options.selectedIndex=-1;b._input.val("")}else if(e==="selectedIndex")if(d>-1){if(b.selectedItem!==null)b.selectedItem.selected=false;if(b.items[d]!==null){b.selectedItem=b.items[d];b.selectedItem.selected=true;b._input.val(b.selectedItem.label)}}},search:function(g,d){var b=this,f,c,e;f=b.options;c=f.data;window.clearTimeout(b.closing);e={value:g,e:d,self:b};if(c!==null){if(d!=="checkindex")if(b._trigger("search",d,{datasrc:c,term:e})===false)return;if(a.isArray(c)){b._hideShowArrow(false);b._onListLoaded(c,e)}else{if(b._usingRemoteData()&&d!==undefined&&g.length<f.minLength)return;b._hideShowArrow(false);c.loaded=b._onListLoaded;c.load(e)}}},_usingRemoteData:function(){var b=this.options.data,c=false;if(!a.isArray(b)&&b!==null&&b.proxy!==null)c=true;return c},_hideShowArrow:function(d){var c=this,b,a;b=c.element;a=c._triggerArrow;a!==undefined&&a[d?"show":"hide"]();b[d?"removeClass":"addClass"]("wijmo-wijcombobox-loading")},_onListLoaded:function(i,g){var c=g.self,k,h,j,d,e,f;k=c._input;h=c.options;j=g.value;d=a.isArray(i)?i:i.items;c.items=d;if(g.e==="checkindex"){e=h.selectedIndex;if(h.selectionMode==="multiple"&&a.isArray(e)){a.each(e,function(e,b){var a=d[b];a.selected=true;c.selectedItems.push(a)});c._selectedItemsToInputVal(c.selectedItems)}else{d[e].selected=true;c.selectedItem=d[e];k.val(c.selectedItem.label)}c._hideShowArrow(true);return}if(!c._usingRemoteData()){c._filter(d,j);f=a.grep(d,function(a){return!h.autoFilter||a.match})}else{c._topHit=null;f=d}if(f.length>0){c._openlist(f,g);c._trigger("open");c._addInputFocus(true,b)}else c.close(null,true);c._hideShowArrow(true)},close:function(h,g){var e=this,d,c,f;d=e.menu;e._dropDownHeight=d.element.outerHeight();e._dropDownWidth=d.element.outerWidth();window.clearTimeout(e.closing);if(d.element.is(":visible")&&!d.element.is(":animated")&&!d.element.parent().is(":animated")){e._trigger("close",h);d.deactivate();c=e.options.hidingAnimation;if(c&&c.effect==="size")c.options=a.extend({to:{width:0,height:0}},c.options);f=d.element.attr("style");if(g!==true&&c)d.element.hide(c.effect,c.options,c.speed,function(){d.element.removeAttr("style").attr("style",f).hide();c.callback&&c.callback.apply(this,arguments)});else d.element.hide();e._addInputFocus(false,b);a(document).unbind("click",e.closeOnClick)}},_change:function(){var a=this,e,f,d,b,g,c;e=a.options;f=e.forceSelectionText;d=e.selectionMode;b=a._input;g=b.val();c=a.selectedItem;if(f)if(d==="single")if(c!==null)c.label!==g&&b.val(c.label);else b.val("");d==="multiple"&&a._selectedItemsToInputVal(a.selectedItems)},_openlist:function(r,n){var b=n.self,f=n.e,i,h,c,e,m,q=2,j=0,g,o,d,k,l;i=b._keypress=!!f;e=b.options;c=b.menu.element;c.zIndex(b.element.zIndex()+1);b.menu.setItems(r);b.menu.renderList();b.menu.element.show();if(e.dropdownWidth==="auto")h=b._comboElement.outerWidth();else h=e.dropdownWidth;m=c.css("padding");c.css("padding","0px");c.setOutWidth(h);c.css("padding",m);g=e.dropdownHeight;if(b._select!==undefined)g=20*b._menuUL.children(".wijmo-wijlist-item:first").outerHeight();if(c.children(".wijmo-wijsuperpanel-header"))j=c.children(".wijmo-wijsuperpanel-header").outerHeight();o=Math.min(b._menuUL.outerHeight()+q+j,g);c.setOutHeight(o);b.menu.refreshSuperPanel();b._positionList();!i&&b.selectedItem!==undefined&&b.menu.activate(null,b.selectedItem,true);if(i&&f.keyCode!==a.ui.keyCode.BACKSPACE)if(e.isEditable)b._runAutoComplete();else b.menu.activate(null,b._topHit,true);else{d=b.options.showingAnimation;if(e.showingAnimation!==null&&!(f!==undefined&&f.keyCode===a.ui.keyCode.BACKSPACE)){b.menu.element.hide();l={from:{width:0,height:0},to:{width:b._dropDownWidth||c.outerWidth(),height:b._dropDownHeight||c.outerHeight()}};if(d&&d.effect==="size")d.options=a.extend(l,d.options);k=c.attr("style");c.show(d.effect,d.options,d.speed,function(){c.removeAttr("style").attr("style",k).show();d.callback&&d.callback.apply(this,arguments);a.browser.msie&&c.css("filter","")})}}if(!b.hasOwnProperty("closeOnClick")){var p=b.closeOnClick;b.closeOnClick=function(a){return p(a)}}a(document).bind("click",b,b.closeOnClick)},closeOnClick:function(c){var b=c.data,d=c.target;if(!a.contains(b._comboElement[0],d)&&!a.contains(b.menu.element[0],d)){b.close();a(".wijmo-wijcombobox-wrapper",b._comboElement[0]).removeClass("ui-state-hover").removeClass("ui-state-focus");a(".wijmo-wijcombobox-trigger",b._comboElement[0]).removeClass("ui-state-hover").removeClass("ui-state-focus")}},_positionList:function(){var c=this,d,b;d=c.options.dropDownListPosition;b={my:"left top",at:"left bottom",of:c._comboElement,collision:"none"};b=a.extend(b,d);c.menu.element.position(b)},_runAutoComplete:function(){var a=this,c,b,e,d,f,g;c=a._input;b=a._topHit;if(!a.options.autoComplete||b===null)return;a.menu.activate(null,b,true);e=c.val();d=b.label;c.val(d);f=e.length;g=d.length;a._selectText(f,g,c)},_selectText:function(d,e,c){var f=c.val(),a=c.get(0),b;if(f.length>0)if(a.setSelectionRange!==undefined)a.setSelectionRange(d,e);else if(a.createTextRange!==undefined){b=a.createTextRange();b.moveStart("character",d);b.moveEnd("character",e-f.length);b.select()}},_move:function(a,b){if(!this.menu.element.is(":visible")){this.search("",b);return}if(this.menu.first()&&/^previous/.test(a)||this.menu.last()&&/^next/.test(a))return;this.menu[a](b)},_escapeRegex:function(a){return a===undefined?a:a.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")},_filter:function(e,f){var c=this._escapeRegex(f),d,b=null;d=new RegExp(c,"i");a.each(e,function(f,a){if(c===undefined||c.length===0){a.match=true;return}var e=d.exec(a.label);if(e===null)a.match=false;else{if(b===null&&e.index===0)b=a;a.match=e.index>=0}});this._topHit=b;return e}})})(jQuery);